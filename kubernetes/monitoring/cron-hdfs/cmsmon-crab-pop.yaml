kind: ConfigMap
apiVersion: v1
metadata:
  name: cmsmon-crab-pop
  namespace: cron-hdfs
  labels:
    app: cmsmon-crab-pop
data:
  run.sh: |
    #!/bin/bash
    # Get env variables, since cron's process environment is different than shell's one
    . /etc/environment
    # Run and print all results(except for Spark logs) to stdout
    /data/CMSSpark/bin/cron4crab_popularity.sh \
      --keytab /etc/secrets/keytab --output /eos/user/c/cmsmonit/www/crabPop/data \
      --p1=5001 --p2=5101 --host=$MY_NODE_NAME --wdir=$WDIR 2>&1
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cmsmon-crab-pop
  namespace: cron-hdfs
spec:
  schedule: "30 20 04 * *"
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      backoffLimit: 0
      template:
        metadata:
          labels:
            app: cmsmon-crab-pop
        spec:
          restartPolicy: Never
          hostname: cmsmon-crab-pop
          containers:
            - name: cmsmon-crab-pop
              image: registry.cern.ch/cmsmonitoring/cmsmon-hdfs:20220904
              imagePullPolicy: Always
              args:
                - /bin/bash
                - -c
                - export >/etc/environment; /data/cronjob/run.sh
              env:
                - name: MY_NODE_NAME
                  valueFrom:
                    fieldRef:
                      fieldPath: spec.nodeName
              ports:
                - containerPort: 5001 # spark.driver.port 5001
                  name: port-1
                - containerPort: 5101 # spark.driver.blockManager.port 5101
                  name: port-2
              resources:
                limits:
                  cpu: 2000m
                  memory: 6Gi
                requests:
                  cpu: 500m
                  memory: 750Mi
              stdin: true
              tty: true
              volumeMounts:
                - name: cmsmon-crab-pop-secrets
                  mountPath: /etc/secrets
                  readOnly: true
                - name: eos # EOS access
                  mountPath: /eos
                  mountPropagation: HostToContainer
                - name: cronjobs-configmap
                  mountPath: /data/cronjob
          volumes:
            - name: cmsmon-crab-pop-secrets
              secret:
                secretName: cmsmon-crab-pop-secrets
            - name: eos
              hostPath:
                path: /var/eos
            - name: cronjobs-configmap
              configMap:
                name: cmsmon-crab-pop
                defaultMode: 0555 # rx

