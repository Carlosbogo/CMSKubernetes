kind: ConfigMap
apiVersion: v1
metadata:
  name: cmsmon-hpc-usage
  namespace: cron-hdfs
  labels:
    app: cmsmon-hpc-usage
data:
  run.sh: |
    #!/bin/bash
    # Get env variables, since cron's process environment is different than shell's one
    . /etc/environment
    # Run and print all results(except for Spark logs) to stdout
    /data/CMSSpark/bin/cron4hpc_usage.sh \
      --keytab /etc/secrets/keytab --output /eos/user/c/cmsmonit/www/hpc_usage \
      --url https://cmsdatapop.web.cern.ch/cmsdatapop/hpc_usage \
      --p1=5001 --p2=5101 --host=$MY_NODE_NAME --wdir=$WDIR --iterative 2>&1
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cmsmon-hpc-usage
  namespace: cron-hdfs
spec:
    schedule: "43 13 * * *"
    concurrencyPolicy: Forbid
    failedJobsHistoryLimit: 1
    jobTemplate:
    spec:
      backoffLimit: 0
      template:
        metadata:
          labels:
            app: cmsmon-hpc-usage
        spec:
          restartPolicy: Never
          hostname: cmsmon-hpc-usage
          containers:
            - name: cmsmon-hpc-usage
              image: registry.cern.ch/cmsmonitoring/cmsmon-hdfs:20220904
              imagePullPolicy: Always
              args:
                - /bin/bash
                - -c
                - export >/etc/environment; /data/cronjob/run.sh
              env:
                - name: MY_NODE_NAME
                  valueFrom:
                    fieldRef:
                      fieldPath: spec.nodeName
              ports:
                - containerPort: 5001 # spark.driver.port
                  name: port-1
                - containerPort: 5101 # spark.driver.blockManager.port
                  name: port-2
              resources:
                limits:
                  cpu: 2000m
                  memory: 6Gi
                requests:
                  cpu: 500m
                  memory: 750Mi
              stdin: true
              tty: true
              volumeMounts:
                - name: cmsmon-hpc-usage-secrets
                  mountPath: /etc/secrets
                  readOnly: true
                - name: eos # EOS access
                  mountPath: /eos
                  mountPropagation: HostToContainer
                - name: cronjobs-configmap
                  mountPath: /data/cronjob
          volumes:
            - name: cmsmon-hpc-usage-secrets
              secret:
                secretName: cmsmon-hpc-usage-secrets
            - name: eos
              hostPath:
                path: /var/eos
            - name: cronjobs-configmap
              configMap:
                name: cmsmon-hpc-usage
                defaultMode: 0555 # rx

